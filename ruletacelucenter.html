<!-- ============================================
     RULETA CELUCENTER - CÃ“DIGO FINAL COMPLETO
     ============================================ -->

<style>
body { text-align:center; color:white; font-family:Arial; }
.ruleta-container {
    width: 360px;
    height: 360px;
    border-radius: 50%;
    border: 10px solid #001B41;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
    background: #001B41;
    box-shadow: 0 0 25px #000a;
}
.indicador {
    width: 0;
    height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-bottom: 28px solid #FFD176;
    position: absolute;
    top: -5px;
    left: calc(50% - 18px);
    z-index: 20;
}
#ruleta {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    transition: transform 5s cubic-bezier(0.12, 0.07, 0.1, 1);
}
.luz {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #FFD176;
    position: absolute;
    animation: luz 1.2s infinite alternate;
}
@keyframes luz {
    0% { opacity: .4; transform: scale(0.8);}
    100% { opacity: 1; transform: scale(1);}
}
#btnGirar {
    margin-top: 10px;
    padding: 12px 26px;
    background: #0066FF;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    color: white;
    cursor: pointer;
}
.overlay {
    display:none;
    position:fixed;
    left:0; top:0;
    width:100%; height:100%;
    background:#000d;
    justify-content:center;
    align-items:center;
    z-index:9999;
}
.card-premio {
    width:320px;
    background:white;
    color:#001B41;
    padding:20px;
    border-radius:16px;
    border:2px dashed #FFD176;
    box-shadow:0 0 20px #ffd17680;
    animation:pop .4s ease;
}
@keyframes pop {
    0% { transform:scale(0.4); opacity:0;}
    100% { transform:scale(1); opacity:1;}
}
.boleto-btn {
    padding:9px 17px;
    background:#001B41;
    color:white;
    border-radius:10px;
    margin-top:10px;
    cursor:pointer;
    border:none;
}
</style>


<div id="mainBox">
    <h1>ðŸŽ‰ Â¡Bienvenido a la Ruleta CeluCenter!</h1>
    <p>Gira la ruleta y gana un descuento para tu compra.</p>
    <p id="sucursalText" style="color:#FFD176;font-size:18px;"></p>

    <div class="ruleta-container" id="ruletaBox">
        <div class="indicador"></div>
        <img id="ruleta" src="https://raw.githubusercontent.com/piztian/SucursalesCelucenter/main/fotos/ruleta/ruleta%20celucenter.png">
    </div>

    <button id="btnGirar">ðŸŽ¡ Girar Ruleta</button>
</div>


<!-- BOLETO -->
<div class="overlay" id="overlay">
    <div class="card-premio">
        <h2>ðŸŽŸ Boleto de Descuento</h2>

        <p><b>Sucursal: </b><span id="bSucursal"></span></p>
        <p><b>Premio: </b><span id="bPremio"></span></p>
        <p><b>Fecha: </b><span id="bFecha"></span></p>
        <p><b>Folio: </b><span id="bFolio"></span></p>

        <p style="font-size:13px;color:#333;margin-top:10px;">
         ðŸ“¸ Toma captura de este boleto y muÃ©stralo en caja.
        </p>

        <a id="waBoleto" 
           style="display:inline-block;margin-top:10px;color:#001B41;font-weight:bold;"
           target="_blank">ðŸ“² WhatsApp CeluCenter</a>

        <button class="boleto-btn" onclick="cerrarBoleto()">Cerrar</button>
    </div>
</div>


<script>
// ==============================================
// CONFIGURACIÃ“N
// ==============================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyRwknpNkU-ED2tiItpXaCC_OLXNALWDGswj3T_sSMh52fKQS8cDnPC45TOVF2ZEaHF/exec";
const WHATSAPP_NUM = "5213321012446";

const premios = [
    {nombre:"20% de descuento", prob:50},
    {nombre:"15% de descuento", prob:25},
    {nombre:"10% de descuento", prob:15},
    {nombre:"5% de descuento",  prob:5},
    {nombre:"25% de descuento", prob:5}
];

// Formato /Sucursal para bot
function formatearSucursalParaBot(nombre) {
    return "/" + nombre.replace(/\s+/g, "_");
}

// ==============================================
// SUCURSAL DESDE URL
// ==============================================
const urlParams = new URLSearchParams(window.location.search);
const sucursal = urlParams.get("sucursal") || "SIN_SUCURSAL";
document.getElementById("sucursalText").textContent = "Sucursal: " + sucursal;


// ==============================================
// CREAR LUCES
// ==============================================
const cont = document.getElementById("ruletaBox");
for (let i=0;i<24;i++){
    const luz=document.createElement("div");
    luz.className="luz";
    const a=(360/24)*i;
    const x=180+150*Math.cos((a-90)*Math.PI/180);
    const y=180+150*Math.sin((a-90)*Math.PI/180);
    luz.style.left=x+"px"; 
    luz.style.top=y+"px";
    luz.style.animationDelay=(i*.05)+"s";
    cont.appendChild(luz);
}


// ==============================================
// GENERADORES
// ==============================================
function premioAleatorio(){
    let total=premios.reduce((s,p)=>s+p.prob,0);
    let r=Math.random()*total,acum=0;
    for(let p of premios){ acum+=p.prob; if(r<=acum) return p.nombre; }
}
function generarFolio(){
    return "CC-" + Math.random().toString(36).substring(2,8).toUpperCase();
}


// ==============================================
// BLOQUEO 5 MINUTOS
// ==============================================
function tiempoRestante() {
    const ultimo = localStorage.getItem("ultimoGiro");
    if (!ultimo) return 0;

    const diff = Date.now() - parseInt(ultimo);
    const cincoMin = 5 * 60 * 1000;

    return Math.max(0, cincoMin - diff);
}

function mostrarCuentaRegresiva(ms) {
    const btn = document.getElementById("btnGirar");
    btn.disabled = true;

    const interval = setInterval(() => {
        const restante = tiempoRestante();
        if (restante <= 0) {
            clearInterval(interval);
            btn.disabled = false;
            btn.textContent = "ðŸŽ¡ Girar Ruleta";
            return;
        }

        const m = Math.floor(restante / 60000);
        const s = Math.floor((restante % 60000) / 1000);

        btn.textContent = `â³ Espera ${m}:${s.toString().padStart(2, '0')}`;
    }, 1000);
}

function verificarBloqueo() {
    const restante = tiempoRestante();
    if (restante > 0) {
        mostrarCuentaRegresiva(restante);
    }
}

verificarBloqueo();


// ==============================================
// GIRO
// ==============================================
let girando = false;

document.getElementById("btnGirar").onclick = () => {

    const restante = tiempoRestante();
    if (restante > 0) return;

    localStorage.setItem("ultimoGiro", Date.now());

    if (girando) return;
    girando = true;

    const ruleta = document.getElementById("ruleta");
    const premio = premioAleatorio();
    const index = premios.findIndex(p => p.nombre === premio);
    const grados = 360 / premios.length;
    const giro = (360*5) - (index*grados) - (grados/2);

    ruleta.style.transform = `rotate(${giro}deg)`;

    setTimeout(() => {

        const fecha = new Date().toLocaleDateString("es-MX");
        const folio = generarFolio();
        const comandoBot = formatearSucursalParaBot(sucursal);

        document.getElementById("bSucursal").textContent = comandoBot;
        document.getElementById("bPremio").textContent = premio;
        document.getElementById("bFecha").textContent = fecha;
        document.getElementById("bFolio").textContent = folio;


        const mensajeWA = encodeURIComponent(
            comandoBot + " - Hola, ganÃ© un premio en la ruleta CeluCenter.\n" +
            "Premio: " + premio + "\n" +
            "Folio: " + folio
        );

        document.getElementById("waBoleto").href =
            "https://wa.me/" + WHATSAPP_NUM + "?text=" + mensajeWA;

        document.getElementById("overlay").style.display = "flex";

        enviarRegistro({
            sucursal,
            comandoBot,
            premio,
            fecha,
            folio,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
        });

        girando = false;

    }, 5000);
};


function cerrarBoleto() {
    document.getElementById("overlay").style.display = "none";
}

function enviarRegistro(data){
    fetch(SCRIPT_URL,{
        method:"POST",
        mode:"no-cors",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
    });
}
</script>
