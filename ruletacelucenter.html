<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CeluCenter ‚Äì Ruleta</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { text-align:center; color:white; font-family:Arial; background:#000; }

/* RULETA */
.ruleta-container {
    width: 360px;
    height: 360px;
    border-radius: 50%;
    border: 10px solid #001B41;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
    background: #001B41;
    box-shadow: 0 0 25px #000a;
}
.indicador {
    width: 0;
    height: 0;
    border-left: 18px solid transparent;
    border-right: 18px solid transparent;
    border-bottom: 28px solid #FFD176;
    position: absolute;
    top: -5px;
    left: calc(50% - 18px);
    z-index: 20;
}
#ruleta {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    transition: transform 5s cubic-bezier(0.12, 0.07, 0.1, 1);
}
.luz {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #FFD176;
    position: absolute;
    animation: luz 1.2s infinite alternate;
}
@keyframes luz {
    0% { opacity: .4; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1); }
}

#btnGirar {
    margin-top: 10px;
    padding: 12px 26px;
    background: #0066FF;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    color: white;
    cursor: pointer;
}
#btnGirar:disabled {
    background: #444;
    cursor: not-allowed;
}

/* Inputs */
.input-field {
    width: 260px;
    padding: 12px;
    border-radius: 12px;
    border: 2px solid #0066FF;
    font-size: 16px;
    margin-top: 10px;
    text-transform: uppercase;
}
.btn-validar {
    margin-top: 10px;
    padding: 10px 22px;
    background: #001B41;
    color:white;
    border:none;
    border-radius: 12px;
    cursor:pointer;
    font-size: 17px;
}
#msgTelefono, #msgTicket, #msgEspera {
    margin-top:8px;
    font-size:14px;
}

/* Boleto */
.overlay {
    display:none;
    position:fixed;
    left:0; top:0;
    width:100%; height:100%;
    background:#000d;
    justify-content:center;
    align-items:center;
    z-index:9999;
}
.card-premio {
    width:320px;
    background:white;
    color:#001B41;
    padding:20px;
    border-radius:16px;
    border:2px dashed #FFD176;
    box-shadow:0 0 20px #ffd17680;
    animation:pop .4s ease;
}
@keyframes pop {
    0% { transform:scale(0.4); opacity:0; }
    100% { transform:scale(1); opacity:1; }
}
.boleto-btn {
    padding:9px 17px;
    background:#001B41;
    color:white;
    border-radius:10px;
    margin-top:10px;
    cursor:pointer;
    border:none;
    width:100%;
}

/* Overlay de carga */
.overlay-carga {
    display:none;
    position:fixed;
    left:0; top:0;
    width:100%; height:100%;
    background:#000d;
    justify-content:center;
    align-items:center;
    z-index:9998;
}
.card-carga {
    background:white;
    color:#001B41;
    padding:30px;
    border-radius:16px;
    text-align:center;
}
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0066FF;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
</head>

<body>

<div id="mainBox">
    <h1>üéâ ¬°Bienvenido a la Ruleta CeluCenter!</h1>
    <p>Ingresa tu n√∫mero y tu ticket para jugar.</p>
    <p id="sucursalText" style="color:#FFD176;font-size:18px;"></p>

    <!-- TELEFONO -->
    <input id="telefono" class="input-field" maxlength="10" placeholder="Tel√©fono (10 d√≠gitos)">
    <div id="msgTelefono"></div>

    <!-- TICKET -->
    <input id="ticket" class="input-field" placeholder="Ticket (Ej: TCKST04001)">
    <div id="msgTicket"></div>

    <!-- MENSAJE DE ESPERA -->
    <div id="msgEspera" style="color:#FFD176;"></div>

    <button class="btn-validar" id="btnValidar">‚úî Validar datos</button>

    <!-- RULETA -->
    <div class="ruleta-container" id="ruletaBox">
        <div class="indicador"></div>
        <img id="ruleta" src="https://raw.githubusercontent.com/piztian/SucursalesCelucenter/main/fotos/ruleta/ruleta%20celucenter.png">
    </div>

    <button id="btnGirar" disabled>üé° Girar Ruleta</button>
</div>

<!-- BOLETO -->
<div class="overlay" id="overlay">
    <div class="card-premio">
        <h2>üéü Boleto de Descuento</h2>

        <p><b>Sucursal: </b><span id="bSucursal"></span></p>
        <p><b>Premio: </b><span id="bPremio"></span></p>
        <p><b>Fecha: </b><span id="bFecha"></span></p>
        <p><b>Folio: </b><span id="bFolio"></span></p>
        <p><b>Ticket: </b><span id="bTicket"></span></p>

        <p style="font-size:13px;color:#333;margin-top:10px;">
         üì∏ Toma captura de este boleto y mu√©stralo en caja.
        </p>

        <button class="boleto-btn" id="btnWhatsapp">üì≤ Enviar por WhatsApp</button>
        <button class="boleto-btn" onclick="cerrarBoleto()">Cerrar</button>
    </div>
</div>

<!-- OVERLAY DE CARGA -->
<div class="overlay-carga" id="overlayCarga">
    <div class="card-carga">
        <div class="spinner"></div>
        <p>Procesando tu premio...</p>
    </div>
</div>

<script>
// =================================================
// CONFIGURACI√ìN
// =================================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyRwknpNkU-ED2tiItpXaCC_OLXNALWDGswj3T_sSMh52fKQS8cDnPC45TOVF2ZEaHF/exec";
const WHATSAPP_NUM = "3321012446";
const premios = [
    {nombre:"20% de descuento", prob:50},
    {nombre:"15% de descuento", prob:25},
    {nombre:"10% de descuento", prob:15},
    {nombre:"5% de descuento",  prob:5},
    {nombre:"25% de descuento", prob:5}
];

// SUCURSAL POR URL
const urlParams = new URLSearchParams(window.location.search);
const sucursal = urlParams.get("sucursal") || "SIN_SUCURSAL";
const comandoBot = "/" + sucursal.replace(/\s+/g, "_");
document.getElementById("sucursalText").textContent = "Sucursal: " + sucursal;

// =================================================
// VARIABLES GLOBALES
// =================================================
let datosOK = false;
let girando = false;
let proximoGiroEn = 0; // timestamp para pr√≥ximo giro permitido

// Cargar timestamp del localStorage
function cargarProximoGiro() {
    const guardado = localStorage.getItem(`celucenter_${sucursal}_proximoGiro`);
    if (guardado) {
        proximoGiroEn = parseInt(guardado);
    }
}

function guardarProximoGiro(timestamp) {
    localStorage.setItem(`celucenter_${sucursal}_proximoGiro`, timestamp.toString());
    proximoGiroEn = timestamp;
}

// Cargar al iniciar
cargarProximoGiro();

// =================================================
// ACTUALIZAR CONTADOR DE ESPERA CADA SEGUNDO
// =================================================
setInterval(() => {
    const ahora = Date.now();
    if (proximoGiroEn > ahora) {
        const segundosFaltan = Math.ceil((proximoGiroEn - ahora) / 1000);
        const minutos = Math.floor(segundosFaltan / 60);
        const segundos = segundosFaltan % 60;
        
        document.getElementById("msgEspera").textContent = 
            `‚è≥ Debes esperar: ${minutos}m ${segundos}s`;
        document.getElementById("btnValidar").disabled = true;
        document.getElementById("btnGirar").disabled = true;
    } else {
        document.getElementById("msgEspera").textContent = "";
        document.getElementById("btnValidar").disabled = false;
        if (datosOK) {
            document.getElementById("btnGirar").disabled = false;
        }
    }
}, 1000);

// =================================================
// VALIDACI√ìN
// =================================================
document.getElementById("btnValidar").onclick = () => {

    const ahora = Date.now();
    if (proximoGiroEn > ahora) {
        const segundosFaltan = Math.ceil((proximoGiroEn - ahora) / 1000);
        alert(`Debes esperar ${segundosFaltan} segundos m√°s.`);
        return;
    }

    const tel = document.getElementById("telefono").value.trim();
    const ticket = document.getElementById("ticket").value.trim().toUpperCase();

    const msgTel = document.getElementById("msgTelefono");
    const msgTick = document.getElementById("msgTicket");

    // Tel√©fono v√°lido MX (10 d√≠gitos)
    const telefonoRegex = /^[0-9]{10}$/;

    if (!telefonoRegex.test(tel)) {
        msgTel.style.color = "red";
        msgTel.textContent = "‚ùó N√∫mero inv√°lido. Debe ser un n√∫mero mexicano v√°lido.";
        datosOK = false;
        document.getElementById("btnGirar").disabled = true;
        return;
    } else {
        msgTel.style.color = "lightgreen";
        msgTel.textContent = "‚úî N√∫mero v√°lido.";
    }

    // Ticket: 3‚Äì5 letras + 4‚Äì8 n√∫meros
    const ticketRegex = /^[A-Z]{3,5}[0-9]{4,8}$/;

    if (!ticketRegex.test(ticket)) {
        msgTick.style.color = "red";
        msgTick.textContent = "‚ùó Ticket inv√°lido. Ejemplo: TCKST04001";
        datosOK = false;
        document.getElementById("btnGirar").disabled = true;
        return;
    } else {
        msgTick.style.color = "lightgreen";
        msgTick.textContent = "‚úî Ticket v√°lido.";
    }

    datosOK = true;
    document.getElementById("btnGirar").disabled = false;
};

// =================================================
// LUCES DECORATIVAS
// =================================================
const cont = document.getElementById("ruletaBox");
for(let i=0;i<24;i++){
    const luz=document.createElement("div");
    luz.className="luz";
    const a=(360/24)*i;
    const x=180+150*Math.cos((a-90)*Math.PI/180);
    const y=180+150*Math.sin((a-90)*Math.PI/180);
    luz.style.left=x+"px"; 
    luz.style.top=y+"px";
    luz.style.animationDelay=(i*.05)+"s";
    cont.appendChild(luz);
}

// =================================================
// Funciones
// =================================================
function premioAleatorio(){
    let total=premios.reduce((s,p)=>s+p.prob,0);
    let r=Math.random()*total,acum=0;
    for(let p of premios){ acum+=p.prob; if(r<=acum) return p.nombre; }
}
function generarFolio(){
    return "CC-" + Math.random().toString(36).substring(2,8).toUpperCase();
}

// =================================================
// GIRAR RULETA
// =================================================
document.getElementById("btnGirar").onclick = () => {

    if (!datosOK) return;
    if (girando) return;

    const ahora = Date.now();
    if (proximoGiroEn > ahora) {
        alert("Debes esperar antes de girar nuevamente.");
        return;
    }

    girando = true;
    document.getElementById("btnGirar").disabled = true;
    document.getElementById("btnValidar").disabled = true;

    // Mostrar carga
    document.getElementById("overlayCarga").style.display = "flex";

    const ruleta = document.getElementById("ruleta");
    const premio = premioAleatorio();
    const index = premios.findIndex(p => p.nombre === premio);
    const grados = 360 / premios.length;
    const giro = (360*5) - (index*grados) - (grados/2);

    ruleta.style.transform = `rotate(${giro}deg)`;

    setTimeout(() => {

        const fecha = new Date().toLocaleDateString("es-MX");
        const folio = generarFolio();
        const telefono = document.getElementById("telefono").value.trim();
        const ticket = document.getElementById("ticket").value.trim().toUpperCase();

        // ENVIAR AL SERVIDOR
        fetch(SCRIPT_URL, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
                sucursal,
                comandoBot,
                telefono,
                ticket,
                premio,
                fecha_cliente: fecha,
                folio,
                userAgent: navigator.userAgent
            })
        })
        .then(response => response.json())
        .then(respuesta => {

            document.getElementById("overlayCarga").style.display = "none";

            // ‚ùå VALIDACIONES DEL SERVIDOR
            if (respuesta.status === "error") {
                alert("‚ùå Error: " + respuesta.message);
                girando = false;
                document.getElementById("btnGirar").disabled = false;
                document.getElementById("btnValidar").disabled = false;
                return;
            }

            if (respuesta.status === "duplicate_ticket") {
                alert("‚ùå Este ticket ya fue usado. Intenta con otro ticket.");
                girando = false;
                document.getElementById("btnGirar").disabled = false;
                document.getElementById("btnValidar").disabled = false;
                return;
            }

            if (respuesta.status === "blocked") {
                const horasPasadas = respuesta.hoursPassed;
                const horasRestantes = Math.ceil(24 - horasPasadas);
                alert(`‚è≥ Solo puedes jugar una vez cada 24 horas.\nIntenta en ${horasRestantes} hora(s).`);
                girando = false;
                document.getElementById("btnGirar").disabled = false;
                document.getElementById("btnValidar").disabled = false;
                return;
            }

            if (respuesta.status === "ok") {
                // ‚úÖ √âXITO: Mostrar boleto y bloquear por 24 horas
                document.getElementById("bSucursal").textContent = sucursal;
                document.getElementById("bPremio").textContent = premio;
                document.getElementById("bFecha").textContent = fecha;
                document.getElementById("bFolio").textContent = folio;
                document.getElementById("bTicket").textContent = ticket;

                document.getElementById("overlay").style.display = "flex";

                // Guardar timestamp para 24 horas despu√©s
                const proximoGiro = Date.now() + (24 * 60 * 60 * 1000);
                guardarProximoGiro(proximoGiro);

                // Bot√≥n WhatsApp
                const btnWhatsapp = document.getElementById("btnWhatsapp");
                btnWhatsapp.onclick = () => {
                    const mensaje = 
`${comandoBot} Hola, gan√© un premio en la ruleta CeluCenter üéâ
üè™ Sucursal: ${sucursal}
üéÅ Premio: ${premio}
üé´ Folio: ${folio}
üßæ Ticket: ${ticket}

Gracias.`;

                    const url = `https://wa.me/52${WHATSAPP_NUM}?text=${encodeURIComponent(mensaje)}`;
                    window.open(url, "_blank");
                };

                girando = false;
            }

        })
        .catch(error => {
            document.getElementById("overlayCarga").style.display = "none";
            console.error("Error:", error);
            alert("‚ùå Error de conexi√≥n. Intenta nuevamente.");
            girando = false;
            document.getElementById("btnGirar").disabled = false;
            document.getElementById("btnValidar").disabled = false;
        });

    }, 5000);
};

function cerrarBoleto() {
    document.getElementById("overlay").style.display = "none";
    // Limpiar inputs
    document.getElementById("telefono").value = "";
    document.getElementById("ticket").value = "";
    document.getElementById("msgTelefono").textContent = "";
    document.getElementById("msgTicket").textContent = "";
    datosOK = false;
    document.getElementById("btnGirar").disabled = true;
}
</script>

</body>
</html>
